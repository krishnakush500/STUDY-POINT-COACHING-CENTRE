<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Point Coaching Centre - Online Test Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* ===== GLOBAL STYLES ===== */
        :root {
            --primary-blue: #1E88E5;
            --light-blue: #42A5F5;
            --dark-blue: #1565C0;
            --primary-red: #D32F2F;
            --light-red: #EF5350;
            --dark-red: #C62828;
            --primary-orange: #FF9800;
            --dark-orange: #F57C00;
            --primary-purple: #7B1FA2;
            --light-purple: #9C27B0;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --medium-gray: #E0E0E0;
            --dark-gray: #616161;
            --text-color: #333333;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== HEADER / COACHING DETAILS ===== */
        .coaching-header {
            background: linear-gradient(to right, var(--primary-blue), var(--dark-blue));
            color: var(--white);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .coaching-header h1 {
            font-size: 1.6rem;
            margin-bottom: 8px;
        }

        .coaching-header .subtitle {
            font-size: 1rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .coaching-header .details {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 12px;
        }

        .coaching-header .detail-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .coaching-header .detail-item i {
            font-size: 1rem;
        }

        /* ===== CARDS ===== */
        .card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-blue);
        }

        .test-card {
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .test-card:hover {
            transform: translateY(-5px);
            border-left-color: var(--light-blue);
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            white-space: nowrap;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--primary-blue);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--dark-blue);
        }

        .btn-secondary {
            background-color: var(--medium-gray);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: var(--dark-gray);
            color: var(--white);
        }

        .btn-danger {
            background-color: var(--primary-red);
            color: var(--white);
        }

        .btn-danger:hover {
            background-color: var(--dark-red);
        }

        .btn-warning {
            background-color: var(--primary-orange);
            color: var(--white);
        }

        .btn-warning:hover {
            background-color: var(--dark-orange);
        }

        .btn-purple {
            background-color: var(--primary-purple);
            color: var(--white);
        }

        .btn-purple:hover {
            background-color: var(--light-purple);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        /* ===== TEST LIST ===== */
        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .test-title {
            font-size: 1.3rem;
            color: var(--primary-blue);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--medium-gray);
        }

        .test-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
        }

        .test-detail {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--dark-gray);
        }

        .test-detail i {
            color: var(--primary-blue);
        }

        /* ===== FORM STYLES ===== */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--medium-gray);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='%231E88E5' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 14px;
            padding-right: 35px;
        }

        /* ===== TEST SCREEN ===== */
        .test-header {
            background-color: var(--white);
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .test-info {
            flex: 1;
            min-width: 200px;
        }

        .test-name {
            font-size: 1.2rem;
            color: var(--primary-blue);
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .student-info {
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .timer-container {
            background-color: var(--light-red);
            color: var(--white);
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1rem;
            min-width: 85px;
            text-align: center;
            flex-shrink: 0;
        }

        .timer-warning {
            background-color: var(--primary-red);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* ===== QUESTION NAVIGATION DROPDOWN ===== */
        .question-navigation {
            background-color: var(--white);
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .jump-to-container {
            flex: 1;
            min-width: 180px;
        }

        .jump-to-label {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--dark-gray);
            font-size: 0.85rem;
        }

        .jump-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--medium-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: var(--white);
        }

        .question-status {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: var(--dark-gray);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .answered-dot {
            background-color: var(--primary-blue);
        }

        .not-answered-dot {
            background-color: var(--medium-gray);
        }

        /* ===== QUESTION CARD ===== */
        .question-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 18px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            min-height: 280px;
            display: flex;
            flex-direction: column;
        }

        .question-number {
            font-size: 1rem;
            color: var(--primary-blue);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .question-text {
            font-size: 1.1rem;
            margin-bottom: 18px;
            line-height: 1.5;
            flex: 1;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border: 1px solid var(--medium-gray);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option:hover {
            background-color: var(--light-gray);
            border-color: var(--primary-blue);
        }

        .option.selected {
            background-color: rgba(30, 136, 229, 0.1);
            border-color: var(--primary-blue);
        }

        .option input {
            margin-right: 10px;
            transform: scale(1.1);
            flex-shrink: 0;
        }

        .option-label {
            font-weight: 600;
            margin-right: 8px;
            color: var(--primary-blue);
            min-width: 18px;
            flex-shrink: 0;
        }

        .option-text {
            flex: 1;
            word-break: break-word;
        }

        /* ===== TEST NAVIGATION BUTTONS - SINGLE ROW ===== */
        .test-navigation-row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-top: 15px;
            background-color: var(--white);
            padding: 12px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .nav-btn {
            flex: 1;
            min-width: 0;
            padding: 10px 8px;
            font-size: 0.85rem;
            position: relative;
        }

        .nav-btn i {
            font-size: 0.9rem;
        }

        .nav-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .nav-btn .spinner {
            display: none;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .question-progress {
            text-align: center;
            margin-bottom: 10px;
            color: var(--dark-gray);
            font-weight: 600;
            font-size: 0.9rem;
            background-color: var(--white);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        /* ===== RESULT SCREEN ===== */
        .result-screen {
            background-color: white;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .result-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .result-top-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 15px;
            padding: 10px;
            flex-wrap: wrap;
        }

        .result-print-area {
            background-color: white;
            border: 2px solid var(--primary-blue);
            border-radius: 10px;
            padding: 18px;
            margin: 0 auto 15px;
            width: 100%;
            max-width: 680px;
            box-shadow: 0 0 15px rgba(0,0,0,0.08);
            flex: 1;
        }

        .coaching-info {
            text-align: center;
            margin-bottom: 18px;
            border-bottom: 3px solid var(--primary-blue);
            padding-bottom: 12px;
        }

        .coaching-name {
            color: var(--primary-blue);
            font-size: 1.6rem;
            margin-bottom: 6px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .coaching-location {
            font-size: 0.95rem;
            color: var(--dark-gray);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .coaching-details {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--dark-gray);
        }

        .coaching-detail {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .director-info {
            background-color: rgba(30, 136, 229, 0.1);
            padding: 8px 10px;
            border-radius: 5px;
            margin-top: 8px;
            font-weight: 600;
        }

        .result-title {
            text-align: center;
            font-size: 1.4rem;
            color: var(--primary-red);
            margin-bottom: 18px;
            padding: 8px;
            background-color: rgba(211, 47, 47, 0.1);
            border-radius: 5px;
        }

        .student-info-result {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 18px;
            background-color: var(--light-gray);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .student-info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed var(--medium-gray);
        }

        .student-info-item:last-child {
            border-bottom: none;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 18px;
            background-color: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
            font-size: 0.85rem;
        }

        .result-table th {
            background-color: var(--primary-blue);
            color: var(--white);
            padding: 10px;
            text-align: left;
            font-size: 0.95rem;
        }

        .result-table td {
            padding: 10px;
            border-bottom: 1px solid var(--medium-gray);
        }

        .result-table tr:last-child td {
            border-bottom: none;
        }

        .result-table .highlight {
            font-weight: bold;
            color: var(--primary-blue);
        }

        .result-table .wrong {
            color: var(--primary-red);
            font-weight: bold;
        }

        .result-status {
            text-align: center;
            font-size: 1.4rem;
            font-weight: bold;
            padding: 12px;
            margin: 12px 0;
            border-radius: 8px;
            min-height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .first-division {
            background-color: rgba(30, 136, 229, 0.2);
            color: var(--primary-blue);
            border: 3px solid var(--primary-blue);
        }

        .second-division {
            background-color: rgba(255, 193, 7, 0.2);
            color: #FF8F00;
            border: 3px solid #FF8F00;
        }

        .third-division {
            background-color: rgba(33, 150, 243, 0.2);
            color: #1976D2;
            border: 3px solid #1976D2;
        }

        .fail-status {
            background-color: rgba(211, 47, 47, 0.15);
            color: var(--primary-red);
            border: 3px solid var(--primary-red);
        }

        .result-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding-top: 15px;
            border-top: 2px solid var(--medium-gray);
            flex-wrap: wrap;
        }

        .result-footer {
            text-align: center;
            margin-top: 15px;
            padding: 12px;
            color: var(--dark-gray);
            font-size: 0.75rem;
            border-top: 1px solid var(--medium-gray);
        }

        /* ===== LOADING & MESSAGES ===== */
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 1.1rem;
            color: var(--dark-gray);
        }

        .loading i {
            color: var(--primary-blue);
            margin-right: 8px;
        }

        .error-message {
            background-color: rgba(211, 47, 47, 0.1);
            color: var(--primary-red);
            padding: 12px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
            font-size: 0.9rem;
        }

        .success-message {
            background-color: rgba(30, 136, 229, 0.1);
            color: var(--primary-blue);
            padding: 12px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
            font-size: 0.9rem;
        }

        /* ===== SUBMISSION OVERLAY ===== */
        .submission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }

        .submission-content {
            background-color: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .submission-spinner {
            font-size: 3rem;
            color: var(--primary-blue);
            margin-bottom: 15px;
            animation: spin 1.5s linear infinite;
        }

        .submission-text {
            font-size: 1.2rem;
            color: var(--text-color);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .submission-subtext {
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        /* ===== FOOTER ===== */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: var(--dark-gray);
            font-size: 0.85rem;
            border-top: 1px solid var(--medium-gray);
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .result-screen,
            .result-screen * {
                visibility: visible;
            }
            
            .result-screen {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            
            .result-print-area {
                border: none;
                box-shadow: none;
                padding: 20px;
                margin: 0;
                max-width: 100%;
                page-break-inside: avoid;
            }
            
            .result-top-actions,
            .result-actions,
            .result-footer {
                display: none !important;
            }
        }

        /* ===== MOBILE RESPONSIVENESS ===== */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .coaching-header {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .coaching-header h1 {
                font-size: 1.4rem;
            }
            
            .coaching-header .details {
                flex-direction: column;
                gap: 8px;
                align-items: center;
            }

            .tests-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-top: 12px;
            }

            .test-header {
                flex-direction: column;
                align-items: stretch;
                padding: 10px 12px;
                margin-bottom: 10px;
            }

            .timer-container {
                align-self: center;
                min-width: 80px;
                padding: 6px 10px;
                font-size: 0.95rem;
            }

            .student-info-result {
                grid-template-columns: 1fr;
                gap: 6px;
                padding: 10px;
                font-size: 0.82rem;
            }
            
            .coaching-name {
                font-size: 1.4rem;
            }
            
            .coaching-location {
                font-size: 0.85rem;
                margin-bottom: 10px;
            }
            
            .coaching-details {
                flex-direction: column;
                gap: 8px;
                align-items: center;
                font-size: 0.8rem;
            }
            
            .director-info {
                font-size: 0.8rem;
                padding: 6px 8px;
            }
            
            .result-print-area {
                padding: 15px;
                border-width: 1px;
                margin-bottom: 12px;
            }
            
            .result-table th,
            .result-table td {
                padding: 8px 6px;
                font-size: 0.82rem;
            }
            
            .result-top-actions,
            .result-actions {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            
            .result-top-actions .btn,
            .result-actions .btn {
                width: 100%;
                max-width: 280px;
                padding: 10px 12px;
            }
            
            .result-status {
                font-size: 1.2rem;
                padding: 10px;
                margin: 10px 0;
                min-height: 48px;
            }
            
            .result-container {
                padding: 8px;
                justify-content: flex-start;
            }
            
            .question-navigation {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 10px 12px;
                margin-bottom: 10px;
            }
            
            .question-status {
                justify-content: center;
            }
            
            .test-navigation-row {
                padding: 10px;
                gap: 6px;
                margin-top: 12px;
            }
            
            .nav-btn {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
            
            .nav-btn i {
                font-size: 0.85rem;
            }
            
            .submission-content {
                padding: 20px;
                max-width: 300px;
            }
            
            .submission-spinner {
                font-size: 2.5rem;
            }
            
            .submission-text {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .coaching-header h1 {
                font-size: 1.3rem;
            }

            .test-name {
                font-size: 1.1rem;
            }
            
            .coaching-name {
                font-size: 1.3rem;
            }
            
            .coaching-location {
                font-size: 0.8rem;
            }
            
            .coaching-details {
                font-size: 0.75rem;
            }
            
            .result-title {
                font-size: 1.2rem;
                margin-bottom: 15px;
                padding: 6px;
            }
            
            .result-print-area {
                padding: 12px;
                border: 1px solid var(--primary-blue);
                box-shadow: 0 0 8px rgba(0,0,0,0.05);
            }
            
            .result-table {
                font-size: 0.8rem;
            }
            
            .student-info-result {
                font-size: 0.8rem;
            }
            
            .question-text {
                font-size: 1.05rem;
                margin-bottom: 15px;
            }
            
            .option {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            
            .question-container {
                padding: 15px;
                min-height: 260px;
                margin-bottom: 10px;
            }
            
            .test-navigation-row {
                padding: 8px;
                gap: 4px;
            }
            
            .nav-btn {
                padding: 8px 4px;
                font-size: 0.75rem;
            }
            
            .nav-btn i {
                font-size: 0.8rem;
            }
            
            .btn {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            
            .submission-content {
                padding: 15px;
                max-width: 280px;
            }
            
            .submission-spinner {
                font-size: 2rem;
                margin-bottom: 10px;
            }
            
            .submission-text {
                font-size: 1rem;
            }
            
            .submission-subtext {
                font-size: 0.8rem;
            }
        }
        
        /* Extra small mobile devices (iPhone SE etc) */
        @media (max-width: 375px) {
            .test-header {
                padding: 8px 10px;
            }
            
            .test-name {
                font-size: 1rem;
            }
            
            .student-info {
                font-size: 0.85rem;
            }
            
            .timer-container {
                min-width: 70px;
                padding: 5px 8px;
                font-size: 0.9rem;
            }
            
            .question-navigation {
                padding: 8px 10px;
            }
            
            .jump-select {
                padding: 7px 10px;
                font-size: 0.85rem;
            }
            
            .question-text {
                font-size: 1rem;
            }
            
            .option {
                padding: 7px 9px;
                font-size: 0.85rem;
            }
            
            .test-navigation-row {
                padding: 8px 6px;
            }
            
            .nav-btn {
                padding: 7px 3px;
                font-size: 0.7rem;
            }
            
            .nav-btn i {
                font-size: 0.75rem;
            }
            
            .btn-small {
                padding: 6px 8px;
                font-size: 0.8rem;
            }
        }
        
        /* Height-based adjustments for mobile */
        @media (max-height: 700px) and (max-width: 768px) {
            .test-header {
                padding: 8px 10px;
                margin-bottom: 8px;
            }
            
            .question-navigation {
                padding: 8px 10px;
                margin-bottom: 8px;
            }
            
            .question-container {
                padding: 12px;
                min-height: 220px;
                margin-bottom: 8px;
            }
            
            .question-text {
                font-size: 1rem;
                margin-bottom: 12px;
            }
            
            .options-container {
                gap: 6px;
            }
            
            .option {
                padding: 8px;
                font-size: 0.9rem;
            }
            
            .test-navigation-row {
                margin-top: 10px;
                padding: 8px;
            }
            
            .question-progress {
                padding: 6px 10px;
                font-size: 0.85rem;
                margin-bottom: 8px;
            }
        }
        
        /* Hide result card template on other pages */
        .page:not(#page-result) .result-print-area {
            display: none;
        }
        
        /* Compact card for mobile */
        .compact-card {
            padding: 12px;
            margin-bottom: 12px;
        }
        
        /* Force no scroll on test screen */
        #page-test-screen .container {
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- Page 1: Test List -->
    <div id="page-test-list" class="page active">
        <div class="container">
            <div class="coaching-header">
                <h1>STUDY POINT COACHING CENTRE</h1>
                <div class="subtitle">मुजफ्फरपुर, बिहार</div>
                <p>Excellence in Education Since 2015</p>
                <div class="details">
                    <div class="detail-item">
                        <i class="fas fa-user-tie"></i>
                        <span>DIRECTOR: GUDDU KUMAR</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-graduation-cap"></i>
                        <span>B.Sc, B.Ed (CTET)</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-phone"></i>
                        <span>Call: +91 6202608202</span>
                    </div>
                </div>
            </div>

            <div class="card compact-card">
                <h2>Available Tests</h2>
                <p>Select a test to begin your examination.</p>
                <div id="loading-tests" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading tests from Firebase...
                </div>
            </div>

            <div id="tests-container" class="tests-grid">
                <!-- Tests will be loaded here from Firebase -->
            </div>

            <div class="footer">
                <p>STUDY POINT COACHING CENTRE &copy; 2024 | Online Test Platform</p>
            </div>
        </div>
    </div>

    <!-- Page 2: Student Details -->
    <div id="page-student-details" class="page">
        <div class="container">
            <div class="coaching-header">
                <h1>STUDY POINT COACHING CENTRE</h1>
                <div class="subtitle">मुजफ्फरपुर, बिहार</div>
                <p>Excellence in Education Since 2015</p>
                <div class="details">
                    <div class="detail-item">
                        <i class="fas fa-user-tie"></i>
                        <span>DIRECTOR: GUDDU KUMAR</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-graduation-cap"></i>
                        <span>B.Sc, B.Ed (CTET)</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-phone"></i>
                        <span>Call: +91 6202608202</span>
                    </div>
                </div>
            </div>

            <div class="card compact-card">
                <h2>Student Registration</h2>
                <p>Please enter your details to proceed with the test.</p>
                
                <form id="student-form">
                    <div class="form-group">
                        <label for="student-name" class="form-label">Full Name *</label>
                        <input type="text" id="student-name" class="form-control" placeholder="Enter your full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="roll-number" class="form-label">Roll Number *</label>
                        <input type="text" id="roll-number" class="form-control" placeholder="Enter your roll number" required>
                    </div>
                    
                    <div id="student-form-error" class="error-message" style="display: none;"></div>
                    
                    <button type="submit" class="btn btn-primary btn-block">Proceed to Test</button>
                    <button type="button" id="back-to-tests" class="btn btn-secondary btn-block" style="margin-top: 10px;">Back to Test List</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Page 3: Test Screen -->
    <div id="page-test-screen" class="page">
        <div class="container">
            <div class="test-header">
                <div class="test-info">
                    <div class="test-name" id="current-test-name">Test Name</div>
                    <div class="student-info">
                        <span id="display-student-name">Student Name</span> | 
                        <span id="display-roll-number">Roll Number</span>
                    </div>
                </div>
                <div class="timer-container" id="timer">
                    15:00
                </div>
            </div>

            <div class="question-navigation">
                <div class="jump-to-container">
                    <div class="jump-to-label">Jump to Question:</div>
                    <select id="jump-to-select" class="form-control jump-select">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="question-status">
                    <div class="status-item">
                        <div class="status-dot answered-dot"></div>
                        <span>Answered</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot not-answered-dot"></div>
                        <span>Not Answered</span>
                    </div>
                </div>
            </div>

            <div class="question-progress" id="question-progress">
                Question 1 of 5
            </div>

            <div class="question-container">
                <div class="question-number" id="question-number">Question 1</div>
                <div class="question-text" id="question-text">
                    Loading question...
                </div>
                
                <div class="options-container" id="options-container">
                    <!-- Options will be loaded here -->
                </div>
            </div>

            <!-- SINGLE ROW NAVIGATION BUTTONS -->
            <div class="test-navigation-row">
                <button id="prev-question" class="btn btn-secondary nav-btn">
                    <i class="fas fa-arrow-left"></i> Prev
                </button>
                <button id="complete-test" class="btn btn-warning nav-btn">
                    <i class="fas fa-paper-plane"></i> Complete
                </button>
                <button id="next-question" class="btn btn-primary nav-btn">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Page 4: Result Screen -->
    <div id="page-result" class="page result-screen">
        <div class="result-container">
            <!-- Top Action Buttons -->
            <div class="result-top-actions">
                <button id="download-pdf-top" class="btn btn-primary">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button id="print-result-top" class="btn btn-secondary">
                    <i class="fas fa-print"></i> Print Result
                </button>
            </div>
            
            <!-- Result Card -->
            <div id="result-print-area" class="result-print-area">
                <!-- Coaching Info -->
                <div class="coaching-info">
                    <div class="coaching-name">STUDY POINT COACHING CENTRE</div>
                    <div class="coaching-location">
                        मुजफ्फरपुर, बिहार | Excellence in Education Since 2015
                    </div>
                    <div class="coaching-details">
                        <div class="coaching-detail director-info">
                            <i class="fas fa-user-tie"></i>
                            <span>DIRECTOR: GUDDU KUMAR (B.Sc, B.Ed CTET)</span>
                        </div>
                        <div class="coaching-detail">
                            <i class="fas fa-phone"></i>
                            <span>Call: +91 6202608202</span>
                        </div>
                    </div>
                </div>
                
                <!-- Result Title -->
                <div class="result-title">
                    <i class="fas fa-award"></i> EXAMINATION RESULT
                </div>
                
                <!-- Student Info -->
                <div class="student-info-result">
                    <div class="student-info-item">
                        <strong>Student Name:</strong>
                        <span id="result-student-name">-</span>
                    </div>
                    <div class="student-info-item">
                        <strong>Roll Number:</strong>
                        <span id="result-roll-number">-</span>
                    </div>
                    <div class="student-info-item">
                        <strong>Test Name:</strong>
                        <span id="result-test-name">-</span>
                    </div>
                    <div class="student-info-item">
                        <strong>Date:</strong>
                        <span id="result-test-date">-</span>
                    </div>
                </div>
                
                <!-- Result Table -->
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Total Questions</td>
                            <td id="total-questions">0</td>
                        </tr>
                        <tr>
                            <td>Attempted</td>
                            <td id="attempted-questions">0</td>
                        </tr>
                        <tr>
                            <td>Correct Answers</td>
                            <td id="correct-answers" class="highlight">0</td>
                        </tr>
                        <tr>
                            <td>Wrong Answers</td>
                            <td id="wrong-answers" class="wrong">0</td>
                        </tr>
                        <tr>
                            <td>Total Marks</td>
                            <td id="total-marks">0</td>
                        </tr>
                        <tr>
                            <td>Marks Obtained</td>
                            <td id="marks-obtained" class="highlight">0</td>
                        </tr>
                        <tr>
                            <td>Percentage</td>
                            <td id="percentage" class="highlight">0%</td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Result Status -->
                <div id="result-status" class="result-status">
                    <!-- Division status will be shown here -->
                </div>
            </div>
            
            <!-- Bottom Action Buttons -->
            <div class="result-actions">
                <button id="new-test" class="btn btn-danger">
                    <i class="fas fa-plus"></i> Take Another Test
                </button>
            </div>
            
            <div class="result-footer">
                <p>This is an electronically generated result. No signature required.</p>
                <p>STUDY POINT COACHING CENTRE &copy; 2024 | Result ID: <span id="result-id">-</span></p>
            </div>
        </div>
    </div>

    <!-- Submission Overlay -->
    <div id="submission-overlay" class="submission-overlay" style="display: none;">
        <div class="submission-content">
            <div class="submission-spinner">
                <i class="fas fa-spinner"></i>
            </div>
            <div class="submission-text">Submitting Test...</div>
            <div class="submission-subtext">Please wait while we process your test and generate results</div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyBDN5ATO_LQ-3THveZDGyvLjtjjavgTIJk",
            authDomain: "study-point-coaching-centre.firebaseapp.com",
            projectId: "study-point-coaching-centre",
            storageBucket: "study-point-coaching-centre.firebasestorage.app",
            messagingSenderId: "1044456595909",
            appId: "1:1044456595909:web:ca77701e20483dc640abac"
        };

        // ===== GLOBAL VARIABLES =====
        let currentPage = 'test-list';
        let tests = [];
        let currentTest = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let studentAnswers = {};
        let timerInterval = null;
        let timeRemaining = 0;
        let studentDetails = {};
        let resultId = '';
        let db = null;
        let currentResultData = null;
        let isSubmitting = false; // Flag to prevent multiple submissions

        // ===== FIREBASE INITIALIZATION =====
        function initializeFirebase() {
            try {
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log("Firebase initialized successfully");
                return true;
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showError("Failed to initialize Firebase. Please check your configuration.");
                return false;
            }
        }

        // ===== LOAD TESTS FROM FIREBASE =====
        async function loadTestsFromFirebase() {
            if (!db) {
                showError("Database not initialized");
                return;
            }

            try {
                const loadingDiv = document.getElementById('loading-tests');
                loadingDiv.style.display = 'block';
                
                // Get all tests from 'tests' collection
                const querySnapshot = await db.collection('tests').get();
                
                tests = [];
                querySnapshot.forEach(doc => {
                    const testData = doc.data();
                    // Add document ID to test data
                    tests.push({
                        id: doc.id,
                        ...testData
                    });
                });
                
                console.log("Loaded tests from Firebase:", tests.length);
                
                if (tests.length === 0) {
                    loadingDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> No tests available in Firebase';
                    return;
                }
                
                loadingDiv.style.display = 'none';
                displayTests();
                
            } catch (error) {
                console.error("Error loading tests from Firebase:", error);
                document.getElementById('loading-tests').innerHTML = 
                    '<i class="fas fa-exclamation-circle"></i> Error loading tests. Please try again later.';
            }
        }

        // ===== PAGE NAVIGATION FUNCTIONS =====
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show requested page
            document.getElementById(`page-${pageId}`).classList.add('active');
            currentPage = pageId;
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // ===== PAGE 1: TEST LIST =====
        function displayTests() {
            const container = document.getElementById('tests-container');
            
            if (tests.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <h3>No Tests Available</h3>
                        <p>There are no published tests at the moment. Please check back later.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tests.map(test => `
                <div class="card test-card" data-test-id="${test.id}">
                    <h3 class="test-title">${test.testName || 'Unnamed Test'}</h3>
                    <div class="test-details">
                        <div class="test-detail">
                            <i class="fas fa-question-circle"></i>
                            <span>${test.totalQuestions || 0} Questions</span>
                        </div>
                        <div class="test-detail">
                            <i class="fas fa-star"></i>
                            <span>${test.totalMarks || 0} Marks</span>
                        </div>
                        <div class="test-detail">
                            <i class="fas fa-clock"></i>
                            <span>${test.duration || 15} Minutes</span>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-block start-test" data-test-id="${test.id}">
                        Start Test
                    </button>
                </div>
            `).join('');
            
            // Add event listeners to start test buttons
            document.querySelectorAll('.start-test').forEach(button => {
                button.addEventListener('click', function() {
                    const testId = this.getAttribute('data-test-id');
                    startTest(testId);
                });
            });
        }

        function startTest(testId) {
            currentTest = tests.find(test => test.id === testId);
            if (!currentTest) {
                alert('Test not found!');
                return;
            }
            
            // Reset answers
            studentAnswers = {};
            currentQuestionIndex = 0;
            
            showPage('student-details');
        }

        // ===== PAGE 2: STUDENT DETAILS =====
        document.getElementById('student-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const studentName = document.getElementById('student-name').value.trim();
            const rollNumber = document.getElementById('roll-number').value.trim();
            const errorDiv = document.getElementById('student-form-error');
            
            // Validation
            if (!studentName || !rollNumber) {
                errorDiv.textContent = 'Please fill in all required fields.';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (studentName.length < 2) {
                errorDiv.textContent = 'Please enter a valid name.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Save student details
            studentDetails = {
                name: studentName,
                rollNumber: rollNumber
            };
            
            // Proceed to test screen
            loadTestQuestions();
        });

        document.getElementById('back-to-tests').addEventListener('click', function() {
            showPage('test-list');
        });

        // ===== PAGE 3: TEST SCREEN =====
        function loadTestQuestions() {
            if (!currentTest) {
                alert('Test not found!');
                showPage('test-list');
                return;
            }
            
            try {
                // Parse questions from the test data
                // Assuming questions are stored in Firebase as an array of objects
                // Each question object should have: text, options (array), correctAnswer
                if (currentTest.questions && Array.isArray(currentTest.questions)) {
                    currentQuestions = currentTest.questions;
                } else if (currentTest.questionsText) {
                    // Fallback to parsing from text format
                    currentQuestions = parseQuestions(currentTest.questionsText);
                } else {
                    throw new Error('No questions found in test data');
                }
                
                // Display test info
                document.getElementById('current-test-name').textContent = currentTest.testName;
                document.getElementById('display-student-name').textContent = studentDetails.name;
                document.getElementById('display-roll-number').textContent = studentDetails.rollNumber;
                
                // Initialize timer
                const duration = currentTest.duration || 15;
                timeRemaining = duration * 60; // Convert to seconds
                
                // Start the timer
                startTimer();
                
                // Initialize question dropdown
                initQuestionDropdown();
                
                // Show first question
                showQuestion(0);
                
                // Show test screen
                showPage('test-screen');
                
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Error loading test questions. Please try another test.');
                showPage('test-list');
            }
        }

        function parseQuestions(questionsText) {
            const questions = [];
            const lines = questionsText.split('\n');
            let currentQuestion = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Check if line starts a new question
                if (line.match(/^Q\d+\./)) {
                    if (currentQuestion) {
                        questions.push(currentQuestion);
                    }
                    
                    currentQuestion = {
                        text: line.replace(/^Q\d+\.\s*/, ''),
                        options: [],
                        correctAnswer: ''
                    };
                }
                // Check for options (A), B), C), D))
                else if (line.match(/^[A-D]\)/)) {
                    if (currentQuestion) {
                        const option = line.substring(2).trim();
                        currentQuestion.options.push(option);
                    }
                }
                // Check for answer line
                else if (line.match(/^Answer:/i)) {
                    if (currentQuestion) {
                        currentQuestion.correctAnswer = line.replace(/^Answer:\s*/i, '').trim();
                    }
                }
                // Append to question text if it's a continuation
                else if (line && currentQuestion && !currentQuestion.correctAnswer) {
                    currentQuestion.text += ' ' + line;
                }
            }
            
            // Add the last question
            if (currentQuestion) {
                questions.push(currentQuestion);
            }
            
            return questions;
        }

        function initQuestionDropdown() {
            const dropdown = document.getElementById('jump-to-select');
            dropdown.innerHTML = '';
            
            currentQuestions.forEach((question, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Question ${index + 1}`;
                dropdown.appendChild(option);
            });
            
            // Add event listener for dropdown change
            dropdown.addEventListener('change', function() {
                const questionIndex = parseInt(this.value);
                if (!isNaN(questionIndex)) {
                    showQuestion(questionIndex);
                }
            });
        }

        function showQuestion(index) {
            if (index < 0 || index >= currentQuestions.length) {
                return;
            }
            
            currentQuestionIndex = index;
            const question = currentQuestions[index];
            
            // Update progress
            document.getElementById('question-progress').textContent = 
                `Question ${index + 1} of ${currentQuestions.length}`;
            
            document.getElementById('question-number').textContent = `Question ${index + 1}`;
            document.getElementById('question-text').textContent = question.text;
            
            // Update dropdown selection
            document.getElementById('jump-to-select').value = index;
            
            // Display options
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            const optionLabels = ['A', 'B', 'C', 'D'];
            
            // Handle both array and object formats for options
            let optionsArray = [];
            if (Array.isArray(question.options)) {
                optionsArray = question.options;
            } else if (typeof question.options === 'object') {
                // Convert object to array
                optionsArray = [
                    question.options.A || '',
                    question.options.B || '',
                    question.options.C || '',
                    question.options.D || ''
                ];
            }
            
            optionsArray.forEach((option, i) => {
                if (!option) return; // Skip empty options
                
                const optionId = `option-${index}-${i}`;
                const isSelected = studentAnswers[index] === optionLabels[i];
                
                const optionElement = document.createElement('div');
                optionElement.className = `option ${isSelected ? 'selected' : ''}`;
                optionElement.innerHTML = `
                    <input type="radio" id="${optionId}" name="question-${index}" value="${optionLabels[i]}"
                           ${isSelected ? 'checked' : ''}>
                    <span class="option-label">${optionLabels[i]})</span>
                    <span class="option-text">${option}</span>
                `;
                
                // Add event listener
                optionElement.addEventListener('click', function() {
                    selectOption(index, optionLabels[i]);
                });
                
                optionsContainer.appendChild(optionElement);
            });
            
            // Update button states
            document.getElementById('prev-question').disabled = index === 0;
            document.getElementById('next-question').disabled = index === currentQuestions.length - 1;
        }

        function selectOption(questionIndex, option) {
            studentAnswers[questionIndex] = option;
            showQuestion(questionIndex); // Refresh to show selection
        }

        function startTimer() {
            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            updateTimerDisplay();
            
            // Start new timer
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                // Check if time is up
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    submitTest();
                }
                
                // Add warning class when less than 5 minutes remain
                const timerElement = document.getElementById('timer');
                if (timeRemaining <= 300) { // 5 minutes = 300 seconds
                    timerElement.classList.add('timer-warning');
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timerElement = document.getElementById('timer');
            
            timerElement.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Navigation buttons - now all in single row
        document.getElementById('prev-question').addEventListener('click', function() {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            }
        });

        document.getElementById('next-question').addEventListener('click', function() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            }
        });

        // Complete test button - now in the same row
        document.getElementById('complete-test').addEventListener('click', function() {
            if (isSubmitting) {
                return; // Prevent multiple clicks
            }
            
            if (confirm('Are you sure you want to complete the test? You cannot go back once submitted.')) {
                submitTest();
            }
        });

        // ===== SHOW SUBMISSION OVERLAY =====
        function showSubmissionOverlay() {
            const overlay = document.getElementById('submission-overlay');
            overlay.style.display = 'flex';
            // Disable all buttons
            document.getElementById('complete-test').disabled = true;
            document.getElementById('prev-question').disabled = true;
            document.getElementById('next-question').disabled = true;
            isSubmitting = true;
        }

        // ===== HIDE SUBMISSION OVERLAY =====
        function hideSubmissionOverlay() {
            const overlay = document.getElementById('submission-overlay');
            overlay.style.display = 'none';
            isSubmitting = false;
        }

        // ===== SAVE RESULT TO FIREBASE =====
        async function saveResultToFirebase(resultData) {
            if (!db) {
                console.error("Firestore not initialized");
                return false;
            }

            try {
                // Create a sanitized test name for collection name (replace spaces and special characters)
                const sanitizedTestName = currentTest.testName
                    .replace(/[^a-zA-Z0-9]/g, '_')
                    .toLowerCase();
                
                // Create result data object
                const resultToSave = {
                    studentName: studentDetails.name,
                    rollNumber: studentDetails.rollNumber,
                    testId: currentTest.id,
                    testName: currentTest.testName,
                    totalQuestions: resultData.totalQuestions,
                    attempted: resultData.attempted,
                    correctAnswers: resultData.correct,
                    wrongAnswers: resultData.wrong,
                    totalMarks: resultData.totalMarks,
                    marksObtained: parseFloat(resultData.marksObtained),
                    percentage: parseFloat(resultData.percentage),
                    division: resultData.division,
                    studentAnswers: studentAnswers,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    resultId: resultId,
                    coachingName: "Study Point Coaching Centre",
                    date: new Date().toISOString().split('T')[0] // YYYY-MM-DD format
                };

                // Save to Firebase
                // Structure: studypointresults -> testName -> results -> individual results
                const docRef = await db.collection('studypointresults')
                    .doc(sanitizedTestName)
                    .collection('results')
                    .add(resultToSave);

                console.log("Result saved to Firebase with ID:", docRef.id);
                return true;
            } catch (error) {
                console.error("Error saving result to Firebase:", error);
                return false;
            }
        }

        // ===== TEST SUBMISSION & RESULT CALCULATION =====
        async function submitTest() {
            // Prevent multiple submissions
            if (isSubmitting) {
                return;
            }
            
            // Show submission overlay
            showSubmissionOverlay();
            
            // Clear timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Add a small delay to ensure overlay is visible
            await new Promise(resolve => setTimeout(resolve, 500));
            
            try {
                // Calculate results
                const totalQuestions = currentQuestions.length;
                let attempted = 0;
                let correct = 0;
                
                for (let i = 0; i < totalQuestions; i++) {
                    if (studentAnswers[i]) {
                        attempted++;
                        if (studentAnswers[i] === currentQuestions[i].correctAnswer) {
                            correct++;
                        }
                    }
                }
                
                const wrong = attempted - correct;
                const totalMarks = currentTest.totalMarks || totalQuestions;
                const marksPerQuestion = totalMarks / totalQuestions;
                const marksObtained = correct * marksPerQuestion;
                const percentage = (marksObtained / totalMarks) * 100;
                
                // Determine Division
                let division = '';
                let statusClass = '';
                
                if (percentage >= 60) {
                    division = 'FIRST DIVISION';
                    statusClass = 'first-division';
                } else if (percentage >= 45) {
                    division = 'SECOND DIVISION';
                    statusClass = 'second-division';
                } else if (percentage >= 33) {
                    division = 'THIRD DIVISION';
                    statusClass = 'third-division';
                } else {
                    division = 'FAIL';
                    statusClass = 'fail-status';
                }
                
                // Generate result ID
                resultId = 'SPC' + Date.now() + Math.floor(Math.random() * 1000);
                
                // Prepare result data
                currentResultData = {
                    totalQuestions,
                    attempted,
                    correct,
                    wrong,
                    totalMarks,
                    marksObtained: marksObtained.toFixed(2),
                    percentage: percentage.toFixed(2),
                    division,
                    statusClass
                };
                
                // Save result to Firebase
                const saveSuccess = await saveResultToFirebase(currentResultData);
                
                // Small delay to show processing
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Hide overlay
                hideSubmissionOverlay();
                
                if (!saveSuccess) {
                    alert("Note: Result could not be saved to server, but you can still download your result.");
                }
                
                // Display results
                displayResults(currentResultData);
                
            } catch (error) {
                console.error("Error submitting test:", error);
                hideSubmissionOverlay();
                alert("Error submitting test. Please try again.");
            }
        }

        function displayResults(results) {
            // Set student and test info
            document.getElementById('result-student-name').textContent = studentDetails.name;
            document.getElementById('result-roll-number').textContent = studentDetails.rollNumber;
            document.getElementById('result-test-name').textContent = currentTest.testName;
            document.getElementById('result-test-date').textContent = new Date().toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
            document.getElementById('result-id').textContent = resultId;
            
            // Set result values
            document.getElementById('total-questions').textContent = results.totalQuestions;
            document.getElementById('attempted-questions').textContent = results.attempted;
            document.getElementById('correct-answers').textContent = results.correct;
            document.getElementById('wrong-answers').textContent = results.wrong;
            document.getElementById('total-marks').textContent = results.totalMarks;
            document.getElementById('marks-obtained').textContent = results.marksObtained;
            document.getElementById('percentage').textContent = `${results.percentage}%`;
            
            // Set division status
            const statusElement = document.getElementById('result-status');
            statusElement.className = `result-status ${results.statusClass}`;
            
            if (results.division === 'FAIL') {
                statusElement.innerHTML = '<i class="fas fa-times-circle"></i> FAIL <i class="fas fa-times-circle"></i>';
            } else {
                statusElement.innerHTML = `<i class="fas fa-trophy"></i> ${results.division} <i class="fas fa-trophy"></i>`;
            }
            
            // Show result page
            showPage('result');
        }

        // ===== RESULT PAGE BUTTONS =====
        document.getElementById('download-pdf-top').addEventListener('click', async function() {
            await downloadResultAsPDF();
        });

        document.getElementById('print-result-top').addEventListener('click', function() {
            window.print();
        });

        document.getElementById('new-test').addEventListener('click', function() {
            // Reset state
            currentTest = null;
            currentQuestions = [];
            currentQuestionIndex = 0;
            studentAnswers = {};
            studentDetails = {};
            currentResultData = null;
            isSubmitting = false;
            
            // Clear form
            document.getElementById('student-form').reset();
            
            // Return to test list
            showPage('test-list');
        });

        // ===== PDF DOWNLOAD FUNCTION =====
        async function downloadResultAsPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const printArea = document.getElementById('result-print-area');
            
            // Show loading
            const downloadBtn = document.getElementById('download-pdf-top');
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            downloadBtn.disabled = true;
            
            try {
                // Temporarily adjust for PDF generation
                const originalTransform = printArea.style.transform;
                const originalMarginTop = printArea.style.marginTop;
                
                // Reset transform for PDF generation
                printArea.style.transform = 'none';
                printArea.style.marginTop = '0';
                
                // Create a clone for PDF generation
                const clone = printArea.cloneNode(true);
                clone.style.width = '700px';
                clone.style.padding = '30px';
                clone.style.fontSize = '14px';
                clone.style.border = '2px solid #1E88E5';
                clone.style.borderRadius = '10px';
                
                // Add clone to body temporarily
                clone.style.position = 'fixed';
                clone.style.left = '-10000px';
                clone.style.top = '0';
                clone.style.zIndex = '-1000';
                document.body.appendChild(clone);
                
                // Use html2canvas with better options for PDF
                const canvas = await html2canvas(clone, {
                    scale: 2,
                    backgroundColor: '#FFFFFF',
                    useCORS: true,
                    logging: false,
                    width: 700,
                    height: clone.scrollHeight,
                    windowWidth: 700
                });
                
                // Remove clone
                document.body.removeChild(clone);
                
                // Restore original transform
                printArea.style.transform = originalTransform;
                printArea.style.marginTop = originalMarginTop;
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190; // A4 width in mm (210mm - 20mm margins)
                const pageHeight = 277; // A4 height in mm (297mm - 20mm margins)
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Check if image fits on one page
                if (imgHeight > pageHeight) {
                    // Scale down to fit on one page
                    const scale = pageHeight / imgHeight;
                    const scaledWidth = imgWidth * scale * 0.95;
                    const scaledHeight = imgHeight * scale * 0.95;
                    
                    // Center on page
                    const xPos = (210 - scaledWidth) / 2;
                    const yPos = (297 - scaledHeight) / 2;
                    
                    pdf.addImage(imgData, 'PNG', xPos, yPos, scaledWidth, scaledHeight);
                } else {
                    // Center vertically
                    const yPos = (pageHeight - imgHeight) / 2;
                    pdf.addImage(imgData, 'PNG', 10, yPos, imgWidth, imgHeight);
                }
                
                // Add footer
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100);
                pdf.text('This is an electronically generated result. No signature required.', 105, 287, { align: 'center' });
                pdf.text(`Result ID: ${resultId} | Generated on: ${new Date().toLocaleDateString()}`, 105, 292, { align: 'center' });
                
                // Save the PDF
                pdf.save(`StudyPoint_Result_${studentDetails.rollNumber}_${resultId}.pdf`);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. You can use the Print button instead.');
            } finally {
                // Restore button
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            }
        }

        // ===== HELPER FUNCTIONS =====
        function showError(message) {
            const container = document.getElementById('tests-container');
            if (container) {
                container.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> ${message}
                    </div>
                `;
            }
        }

        // ===== INITIALIZE APP =====
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Firebase
            if (initializeFirebase()) {
                // Load tests from Firebase
                loadTestsFromFirebase();
            }
            
            // Set up keyboard navigation for test screen
            document.addEventListener('keydown', function(e) {
                if (currentPage === 'test-screen') {
                    if (e.key === 'ArrowLeft' && currentQuestionIndex > 0) {
                        showQuestion(currentQuestionIndex - 1);
                    } else if (e.key === 'ArrowRight' && currentQuestionIndex < currentQuestions.length - 1) {
                        showQuestion(currentQuestionIndex + 1);
                    } else if (e.key >= '1' && e.key <= '4') {
                        // Select option with number keys (1-4 for A-D)
                        const optionIndex = parseInt(e.key) - 1;
                        const optionLabels = ['A', 'B', 'C', 'D'];
                        if (optionIndex < currentQuestions[currentQuestionIndex].options.length) {
                            selectOption(currentQuestionIndex, optionLabels[optionIndex]);
                        }
                    } else if (e.key === 'Enter') {
                        // Enter to go to next question if available
                        if (currentQuestionIndex < currentQuestions.length - 1) {
                            showQuestion(currentQuestionIndex + 1);
                        }
                    }
                }
            });
        });

        // ===== ERROR HANDLING =====
        window.addEventListener('error', function(e) {
            console.error('Application error:', e.error);
            
            // Show user-friendly error message
            if (currentPage === 'test-screen') {
                alert('An error occurred during the test. Please try again.');
            }
        });
    </script>
</body>
</html>
